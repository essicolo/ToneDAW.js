<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ToneDAW - Positioning Fix Verification</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://unpkg.com/@tonejs/midi@2.0.28/build/Midi.js"></script>
    <script src="./ToneDAW.js"></script>
</head>
<body>
    <h1>ðŸ”§ Positioning Fix Verification</h1>
    
    <div style="margin: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
        <h3>ðŸŽ¯ Fix Applied</h3>
        <p><strong>Issue:</strong> Double time conversion in loop expansion</p>
        <p><strong>Fixed:</strong> Removed double conversion in condition check</p>
        <p><strong>Result:</strong> Looped notes should now align properly with original notes</p>
    </div>

    <div id="daw"></div>
    
    <div style="margin: 20px; padding: 15px; background: #d1ecf1; border-radius: 8px; border-left: 4px solid #bee5eb;">
        <h3>ðŸ§ª Visual Verification</h3>
        <ul>
            <li>All notes in the same track should be at the same vertical level</li>
            <li>Original notes (solid borders) and looped notes (dashed borders) should align horizontally</li>
            <li>Each track should have a different color</li>
            <li>Looped notes should have the â†» icon</li>
        </ul>
    </div>

    <script>
        const testData = {
            bpm: 120,
            keySignature: "C major",
            metadata: {
                title: "Positioning Fix Test",
                composer: "Fix Verification"
            },
            sequences: [
                {
                    label: "Short Loop Track",
                    group: "test",
                    loop: "0:2", // Loop every 2 beats - should show multiple repetitions
                    synth: { type: 'Synth' },
                    notes: [
                        { note: 'C4', time: 0, duration: '8n', velocity: 0.8 },
                        { note: 'E4', time: '0:1', duration: '8n', velocity: 0.7 }
                    ]
                },
                {
                    label: "Standard Loop Track",
                    group: "test",
                    loop: "1:0", // Loop every measure
                    synth: { type: 'FMSynth' },
                    notes: [
                        { note: 'F3', time: 0, duration: '4n', velocity: 0.9 },
                        { note: 'A3', time: '0:2', duration: '4n', velocity: 0.8 }
                    ]
                },
                {
                    label: "No Loop Track",
                    group: "test",
                    loop: false,
                    synth: { type: 'AMSynth' },
                    notes: [
                        { note: 'C5', time: 0, duration: '2n', velocity: 0.7 },
                        { note: 'G5', time: '2:0', duration: '2n', velocity: 0.7 }
                    ]
                }
            ]
        };

        console.log('ðŸ”§ Testing positioning fix...');
        
        const daw = new ToneDAW('daw', testData);
        
        // Verify that looped notes have correct time format
        testData.sequences.forEach((seq, i) => {
            if (seq.loop && seq.loop !== false) {
                console.log(`\nðŸ“Š Track ${i + 1}: "${seq.label}"`);
                const expanded = daw.expandNotesWithLoop(seq);
                
                console.log('Original notes:');
                const originalNotes = expanded.filter(n => !n.isLooped);
                originalNotes.forEach(note => {
                    console.log(`  ${note.note} at ${note.time} (type: ${typeof note.time})`);
                });
                
                console.log('Looped notes:');
                const loopedNotes = expanded.filter(n => n.isLooped);
                loopedNotes.forEach(note => {
                    console.log(`  ${note.note} at ${note.time}s (type: ${typeof note.time})`);
                });
                
                // Check positioning calculation
                expanded.forEach((note, j) => {
                    const startTime = typeof note.time === 'number' ? note.time : Tone.Time(note.time).toSeconds();
                    const leftPos = startTime * daw.pixelsPerSecond;
                    console.log(`    Note ${j}: startTime=${startTime}s â†’ left=${leftPos}px`);
                });
            }
        });
        
        console.log('\nâœ… If positioning is correct, all notes in each track should be aligned vertically');
    </script>
</body>
</html>
