<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ToneDAW - Timing Test</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://unpkg.com/@tonejs/midi@2.0.28/build/Midi.js"></script>
    <script src="./ToneDAW.js"></script>
</head>
<body>
    <h1>ToneDAW - Timing Verification Test</h1>
    <div id="daw"></div>
    
    <div style="margin: 20px; padding: 20px; background: #f0f0f0; border-radius: 8px;">
        <h3>Expected Note Positions (with pixelsPerSecond = 60):</h3>
        <ul>
            <li><strong>Lead Melody Track:</strong>
                <ul>
                    <li>C4 at time 0 → 0 pixels from left</li>
                    <li>E4 at time "0:1" (0.5s at 120 BPM) → 30 pixels from left</li>
                    <li>G4 at time "0:2" (1.0s at 120 BPM) → 60 pixels from left</li>
                    <li>[C4,E4,G4] chord at time "0:3" (1.5s at 120 BPM) → 90 pixels from left</li>
                </ul>
            </li>
            <li><strong>Bass Line Track:</strong>
                <ul>
                    <li>C3 at time 0 → 0 pixels from left</li>
                    <li>F3 at time "0:2" (1.0s at 120 BPM) → 60 pixels from left</li>
                    <li>G3 at time "1:0" (2.0s at 120 BPM) → 120 pixels from left</li>
                    <li>C3 at time "1:2" (3.0s at 120 BPM) → 180 pixels from left</li>
                </ul>
            </li>
        </ul>
        <p><strong>Note:</strong> The progress line should move in sync with the note positions during playback.</p>
        <p><strong>Test:</strong> Click play and verify that the red progress line passes over each note block at the correct timing when you hear the note play.</p>
    </div>

    <script>
        const projectData = {
            bpm: 120,
            keySignature: "C major",
            metadata: {
                title: "Timing Test Composition",
                composer: "Test Suite"
            },
            sequences: [
                {
                    label: "Lead Melody",
                    group: "lead",
                    loop: true,
                    synth: { type: 'Synth' },
                    notes: [
                        { note: 'C4', time: 0, duration: '4n', velocity: 0.8 },
                        { note: 'E4', time: '0:1', duration: '4n', velocity: 0.7 },
                        { note: 'G4', time: '0:2', duration: '4n', velocity: 0.9 },
                        { note: ['C4', 'E4', 'G4'], time: '0:3', duration: '4n', velocity: 0.6 }
                    ]
                },
                {
                    label: "Bass Line",
                    group: "bass",
                    loop: true,
                    synth: { type: 'FMSynth' },
                    notes: [
                        { note: 'C3', time: 0, duration: '2n', velocity: 0.9 },
                        { note: 'F3', time: '0:2', duration: '2n', velocity: 0.8 },
                        { note: 'G3', time: '1:0', duration: '2n', velocity: 0.9 },
                        { note: 'C3', time: '1:2', duration: '2n', velocity: 0.7 }
                    ]
                }
            ]
        };

        const daw = new ToneDAW('daw', projectData);
        
        // Add timing debug info
        console.log('Timing verification:');
        projectData.sequences.forEach((seq, seqIndex) => {
            console.log(`Track ${seqIndex + 1} (${seq.label}):`);
            seq.notes.forEach((note, noteIndex) => {
                const timeInSeconds = Tone.Time(note.time).toSeconds();
                const expectedPixelPosition = timeInSeconds * 60; // pixelsPerSecond = 60
                console.log(`  Note ${noteIndex + 1}: ${Array.isArray(note.note) ? note.note.join(',') : note.note} at ${note.time} = ${timeInSeconds}s → ${expectedPixelPosition}px`);
            });
        });
    </script>
</body>
</html>
