<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ToneDAW - Loop Positioning Test</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://unpkg.com/@tonejs/midi@2.0.28/build/Midi.js"></script>
    <script src="./ToneDAW.js"></script>
</head>
<body>
    <h1>ðŸ”§ Loop Positioning Fix Test</h1>
    
    <div style="margin: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
        <h3>ðŸŽ¯ Testing Fix for Vertical Note Positioning</h3>
        <p><strong>Issue:</strong> Looped notes were vertically misplaced due to double time conversion</p>
        <p><strong>Fix:</strong> Handle time values correctly - use seconds directly if already converted</p>
        <p><strong>Expected:</strong> All notes should be properly aligned in their track lanes</p>
    </div>

    <div id="daw"></div>
    
    <div style="margin: 20px; padding: 15px; background: #d4edda; border-radius: 8px; border-left: 4px solid #28a745;">
        <h3>âœ… Visual Validation</h3>
        <ul>
            <li>Original notes (solid borders) should be in correct positions</li>
            <li>Looped notes (dashed borders) should be aligned in same track lanes</li>
            <li>No vertical offset between original and looped notes</li>
            <li>All notes should stay within their designated track boundaries</li>
        </ul>
    </div>

    <script>
        const testData = {
            bpm: 120,
            keySignature: "C major",
            metadata: {
                title: "Loop Positioning Test",
                composer: "Bug Fix Validation"
            },
            sequences: [
                {
                    label: "Quick Loop Test",
                    group: "test",
                    loop: "0:2", // Very short loop to see multiple repetitions
                    synth: { type: 'Synth' },
                    notes: [
                        { note: 'C4', time: 0, duration: '8n', velocity: 0.8 },
                        { note: 'E4', time: '0:1', duration: '8n', velocity: 0.7 }
                    ]
                },
                {
                    label: "Medium Loop Test",
                    group: "test",
                    loop: "1:0", // Standard measure loop
                    synth: { type: 'FMSynth' },
                    notes: [
                        { note: 'F3', time: 0, duration: '4n', velocity: 0.9 },
                        { note: 'A3', time: '0:2', duration: '4n', velocity: 0.8 }
                    ]
                },
                {
                    label: "Chord Loop Test",
                    group: "test",
                    loop: "2:0", // Two measure loop
                    synth: { type: 'PolySynth' },
                    notes: [
                        { note: ['C4', 'E4', 'G4'], time: 0, duration: '2n', velocity: 0.6 },
                        { note: ['F4', 'A4', 'C5'], time: '1:0', duration: '2n', velocity: 0.6 }
                    ]
                }
            ]
        };

        console.log('ðŸ”§ Testing loop positioning fix...');
        
        const daw = new ToneDAW('daw', testData);
        
        // Log expanded notes to verify time values
        testData.sequences.forEach((seq, i) => {
            console.log(`\nðŸ“Š Track ${i + 1}: "${seq.label}"`);
            console.log('Original notes:', seq.notes.map(n => ({ note: n.note, time: n.time })));
            
            const expanded = daw.expandNotesWithLoop(seq);
            const loopedNotes = expanded.filter(n => n.isLooped);
            if (loopedNotes.length > 0) {
                console.log('Looped notes:', loopedNotes.map(n => ({ note: n.note, time: n.time, isLooped: n.isLooped })));
            }
        });
        
        console.log('\nâœ… Check visual alignment: All notes should be in proper track lanes');
    </script>
</body>
</html>
