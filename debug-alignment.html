<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ToneDAW - Vertical Alignment Debug</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://unpkg.com/@tonejs/midi@2.0.28/build/Midi.js"></script>
    <script src="./ToneDAW.js"></script>
</head>
<body>
    <h1>üîç Vertical Alignment Debug</h1>
    
    <div style="margin: 20px; padding: 15px; background: #fff3cd; border-radius: 8px;">
        <h3>üêõ Debugging Note Positioning</h3>
        <p>This test isolates the vertical positioning issue with looped notes.</p>
        <p><strong>Check the browser console</strong> for detailed positioning information.</p>
    </div>

    <div id="daw"></div>
    
    <style>
        /* Debug styles to see positioning clearly */
        .daw-track-lane {
            border: 2px solid #ff0000 !important;
            background: rgba(255, 255, 0, 0.1) !important;
        }
        
        .daw-note-block {
            border: 2px solid #000 !important;
        }
        
        .daw-note-block.looped-note {
            background: rgba(255, 0, 0, 0.7) !important;
            border: 2px dashed #ff0000 !important;
        }
    </style>

    <script>
        const debugData = {
            bpm: 120,
            keySignature: "C major",
            metadata: {
                title: "Debug Test",
                composer: "Alignment Test"
            },
            sequences: [
                {
                    label: "Simple Loop",
                    group: "test",
                    loop: "0:2", // 2 beats loop
                    synth: { type: 'Synth' },
                    notes: [
                        { note: 'C4', time: 0, duration: '4n', velocity: 0.8 }
                    ]
                }
            ]
        };

        console.log('üîç Starting debug test...');
        
        const daw = new ToneDAW('daw', debugData);
        
        // Manual test of expandNotesWithLoop
        const seq = debugData.sequences[0];
        console.log('\nüìä Original sequence:', seq);
        
        const expanded = daw.expandNotesWithLoop(seq);
        console.log('\nüìà Expanded notes:');
        expanded.forEach((note, i) => {
            console.log(`  ${i}: note=${note.note}, time=${note.time}, isLooped=${note.isLooped || false}`);
            
            // Show what the positioning calculation would be
            const startTime = typeof note.time === 'number' ? note.time : Tone.Time(note.time).toSeconds();
            const leftPos = startTime * daw.pixelsPerSecond;
            console.log(`      ‚Üí startTime=${startTime}s, leftPos=${leftPos}px`);
        });
        
        // Check if time values are consistent
        console.log('\nüîß Time value analysis:');
        const originalNote = expanded[0];
        const loopedNotes = expanded.filter(n => n.isLooped);
        
        console.log(`Original note time: ${originalNote.time} (type: ${typeof originalNote.time})`);
        loopedNotes.forEach((note, i) => {
            console.log(`Looped note ${i} time: ${note.time} (type: ${typeof note.time})`);
        });
    </script>
</body>
</html>
