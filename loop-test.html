<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ToneDAW - Advanced Loop Test</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://unpkg.com/@tonejs/midi@2.0.28/build/Midi.js"></script>
    <script src="./ToneDAW.js"></script>
</head>
<body>
    <h1>ToneDAW - Advanced Loop System Test</h1>
    <div id="daw"></div>
    
    <div style="margin: 20px; padding: 20px; background: #f0f0f0; border-radius: 8px;">
        <h3>New Loop System Features:</h3>
        <ul>
            <li><strong>Precise Loop Control:</strong> Set exact loop end times (e.g., "0:4", "1:0", "2:0")</li>
            <li><strong>Visual Loop Indicators:</strong> Looped notes appear with dashed borders and reduced opacity</li>
            <li><strong>Data-Driven Loops:</strong> Loops are expanded in the data layer, not just in Tone.js</li>
            <li><strong>Per-Track Loop Settings:</strong> Each track can have different loop lengths</li>
        </ul>
        
        <h3>Test Instructions:</h3>
        <ol>
            <li>Try changing the "Loop End" field for different tracks (e.g., "0:2", "1:0")</li>
            <li>Leave the field empty to disable looping for that track</li>
            <li>Notice how looped notes appear as dashed blocks</li>
            <li>Export MIDI/WAV to hear the full repeated sequences</li>
        </ol>
        
        <h3>Example Loop End Values:</h3>
        <ul>
            <li><code>0:2</code> - Loop every 2 beats (1 second at 120 BPM)</li>
            <li><code>0:4</code> - Loop every 4 beats (2 seconds at 120 BPM)</li>
            <li><code>1:0</code> - Loop every 1 measure (2 seconds at 120 BPM)</li>
            <li><code>2:0</code> - Loop every 2 measures (4 seconds at 120 BPM)</li>
        </ul>
    </div>

    <script>
        const projectData = {
            bpm: 120,
            keySignature: "C major",
            metadata: {
                title: "Advanced Loop Demo",
                composer: "Loop Test Suite"
            },
            sequences: [
                {
                    label: "Short Loop Melody",
                    group: "lead",
                    loop: "0:2", // Loop every 2 beats
                    synth: { type: 'Synth' },
                    notes: [
                        { note: 'C4', time: 0, duration: '8n', velocity: 0.8 },
                        { note: 'E4', time: '0:1', duration: '8n', velocity: 0.7 }
                    ]
                },
                {
                    label: "Medium Loop Bass",
                    group: "bass",
                    loop: "1:0", // Loop every measure
                    synth: { type: 'FMSynth' },
                    notes: [
                        { note: 'C3', time: 0, duration: '4n', velocity: 0.9 },
                        { note: 'F3', time: '0:2', duration: '4n', velocity: 0.8 }
                    ]
                },
                {
                    label: "Long Loop Chords",
                    group: "harmony",
                    loop: "2:0", // Loop every 2 measures
                    synth: { type: 'PolySynth' },
                    notes: [
                        { note: ['C4', 'E4', 'G4'], time: 0, duration: '2n', velocity: 0.6 },
                        { note: ['F4', 'A4', 'C5'], time: '1:0', duration: '2n', velocity: 0.6 }
                    ]
                },
                {
                    label: "No Loop Percussion",
                    group: "drums", 
                    loop: false, // No looping
                    synth: { type: 'AMSynth' },
                    notes: [
                        { note: 'C2', time: 0, duration: '16n', velocity: 1.0 },
                        { note: 'C2', time: '0:1', duration: '16n', velocity: 0.5 },
                        { note: 'C2', time: '0:2', duration: '16n', velocity: 1.0 },
                        { note: 'C2', time: '0:3', duration: '16n', velocity: 0.5 },
                        { note: 'C2', time: '1:0', duration: '16n', velocity: 1.0 }
                    ]
                }
            ]
        };

        const daw = new ToneDAW('daw', projectData);
        
        console.log('Advanced Loop System Demo:');
        console.log('Track 1: Loops every 0:2 (2 beats)');
        console.log('Track 2: Loops every 1:0 (1 measure)');
        console.log('Track 3: Loops every 2:0 (2 measures)');
        console.log('Track 4: No looping');
    </script>
</body>
</html>
