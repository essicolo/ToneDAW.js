<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ToneDAW - Loop System Comparison</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://unpkg.com/@tonejs/midi@2.0.28/build/Midi.js"></script>
    <script src="./ToneDAW.js"></script>
</head>
<body>
    <h1>ToneDAW - Loop System Comparison</h1>
    
    <div style="margin: 20px; padding: 20px; background: #e8f4f8; border-radius: 8px; border-left: 4px solid #2196F3;">
        <h3>ðŸ”„ Hybrid Loop System</h3>
        <p><strong>Playback:</strong> Uses Tone.js native <code>Part.loop</code> with <code>loopEnd</code> for precise timing</p>
        <p><strong>Visualization:</strong> Shows expanded loop repetitions as visual note blocks</p>
        <p><strong>Export:</strong> MIDI uses expanded notes, WAV uses Tone.js native loops</p>
        
        <h4>Benefits:</h4>
        <ul>
            <li>âœ… <strong>Precise Timing:</strong> Leverages Tone.js's built-in loop precision</li>
            <li>âœ… <strong>Visual Clarity:</strong> See all loop repetitions in the interface</li>
            <li>âœ… <strong>Less Custom Code:</strong> Simpler playback logic</li>
            <li>âœ… <strong>Standard Behavior:</strong> Follows expected DAW conventions</li>
            <li>âœ… <strong>Performance:</strong> Tone.js handles timing optimally</li>
        </ul>
    </div>
    
    <div id="daw"></div>
    
    <div style="margin: 20px; padding: 20px; background: #f0f0f0; border-radius: 8px;">
        <h3>ðŸ§ª Test Instructions:</h3>
        <ol>
            <li><strong>Listen to Playback:</strong> Click play and verify smooth loop timing</li>
            <li><strong>Visual Verification:</strong> Notice looped notes are still shown with dashed borders</li>
            <li><strong>Try Different Loop Lengths:</strong> Edit "Loop End" fields (e.g., "0:2", "1:0", "2:0")</li>
            <li><strong>Export Testing:</strong> Export MIDI/WAV and verify loops work correctly</li>
            <li><strong>Performance Check:</strong> Should be smoother than pure custom system</li>
        </ol>
        
        <h3>ðŸŽ¹ Example Loop Settings:</h3>
        <ul>
            <li><code>0:1</code> - Loop every beat (very fast for percussion)</li>
            <li><code>0:2</code> - Loop every 2 beats (short melodic phrases)</li>
            <li><code>0:4</code> - Loop every 4 beats (one measure in 4/4)</li>
            <li><code>1:0</code> - Loop every measure (common for bass lines)</li>
            <li><code>2:0</code> - Loop every 2 measures (chord progressions)</li>
            <li><code>4:0</code> - Loop every 4 measures (song sections)</li>
        </ul>
    </div>

    <script>
        const projectData = {
            bpm: 120,
            keySignature: "C major",
            metadata: {
                title: "Hybrid Loop System Demo",
                composer: "Loop Comparison Test"
            },
            sequences: [
                {
                    label: "Fast Percussion",
                    group: "drums",
                    loop: "0:2", // Very short loop - 2 beats
                    synth: { type: 'AMSynth' },
                    notes: [
                        { note: 'C2', time: 0, duration: '16n', velocity: 1.0 },
                        { note: 'C2', time: '0:1', duration: '16n', velocity: 0.6 }
                    ]
                },
                {
                    label: "Bass Line",
                    group: "bass",
                    loop: "1:0", // Standard measure loop
                    synth: { type: 'FMSynth' },
                    notes: [
                        { note: 'C3', time: 0, duration: '4n', velocity: 0.9 },
                        { note: 'F3', time: '0:2', duration: '4n', velocity: 0.8 }
                    ]
                },
                {
                    label: "Melody",
                    group: "lead",
                    loop: "2:0", // 2-measure loop
                    synth: { type: 'Synth' },
                    notes: [
                        { note: 'C4', time: 0, duration: '4n', velocity: 0.8 },
                        { note: 'E4', time: '0:2', duration: '4n', velocity: 0.7 },
                        { note: 'G4', time: '1:0', duration: '4n', velocity: 0.9 },
                        { note: ['C4', 'E4', 'G4'], time: '1:2', duration: '4n', velocity: 0.6 }
                    ]
                },
                {
                    label: "Background Chords",
                    group: "harmony",
                    loop: "4:0", // Long 4-measure loop
                    synth: { type: 'PolySynth' },
                    notes: [
                        { note: ['C4', 'E4', 'G4'], time: 0, duration: '1n', velocity: 0.4 },
                        { note: ['F4', 'A4', 'C5'], time: '1:0', duration: '1n', velocity: 0.4 },
                        { note: ['G4', 'B4', 'D5'], time: '2:0', duration: '1n', velocity: 0.4 },
                        { note: ['C4', 'E4', 'G4'], time: '3:0', duration: '1n', velocity: 0.4 }
                    ]
                },
                {
                    label: "No Loop Example",
                    group: "special",
                    loop: false, // No looping
                    synth: { type: 'DuoSynth' },
                    notes: [
                        { note: 'C5', time: 0, duration: '2n', velocity: 0.5 },
                        { note: 'E5', time: '2:0', duration: '2n', velocity: 0.5 },
                        { note: 'G5', time: '4:0', duration: '2n', velocity: 0.5 }
                    ]
                }
            ]
        };

        const daw = new ToneDAW('daw', projectData);
        
        console.log('ðŸ”„ Hybrid Loop System Active:');
        console.log('âœ… Playback: Tone.js Part.loop with precise loopEnd timing');
        console.log('âœ… Visual: Custom expandNotesWithLoop() for display');
        console.log('âœ… Export: MIDI uses expanded notes, WAV uses Tone.js loops');
        console.log('');
        console.log('Track Details:');
        projectData.sequences.forEach((seq, i) => {
            console.log(`${i + 1}. "${seq.label}": loop=${seq.loop || 'false'}`);
        });
    </script>
</body>
</html>
